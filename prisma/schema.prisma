// prisma/schema.prisma

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider        = "prisma-client-js"
}

enum UserRole {
    CUSTOMER
    COURIER
}

enum OrderStatus {
    PENDING
    EN_ROUTE_PICKUP
    PICKED_UP
    DELIVERED
}

model User {
    id         Int      @id @default(autoincrement())
    username   String   @unique
    email      String   @unique
    password   String
    firstName  String
    lastName   String?
    address    String
    city       String
    state      String
    zip        String
    phone      String
    role       UserRole @default(CUSTOMER)
    orders     Order[]
    courierOrders   Order[] @relation("CourierOrders")
    orderHistoryChangedBy OrderHistory[] @relation("OrderHistoryChangedBy")
    savedRecipients Recipient[]
    createdAt  DateTime @default(now())
}

model Recipient {
    id             Int      @id @default(autoincrement())
    name           String   // e.g., "Mom", "Office", "John Smith"
    address        String
    contactName    String?  // Optional: full name if different from 'name'
    contactPhone   String?
    instructions   String?
    userId         Int
    user           User     @relation(fields: [userId], references: [id])
    timesUsed      Int      @default(0)
    createdAt      DateTime @default(now())
    @@unique([userId, address, name]) // Prevent duplicates per user
}

model Order {
    id                  Int      @id @default(autoincrement())
    customerId          Int
    customer            User @relation(fields: [customerId], references: [id])
    courierId           Int?
    courier             User? @relation("CourierOrders", fields: [courierId], references: [id])
    pickupDate          DateTime
    pickupTime          String   // Time as string (e.g., "14:30") for form compatibility
    pickupAddress       String
    pickupContactName   String?
    pickupContactPhone  String?
    pickupInstructions  String?
    totalPieces         Int
    orderWeight         Float    // Use Float for weight (e.g., 5.5 lbs)
    dropoffAddress      String
    dropoffContactName  String?
    dropoffContactPhone String?
    dropoffInstructions String?
    status              OrderStatus   @default(PENDING) // values: pending, en_route_pickup, picked_up, delivered
    createdAt           DateTime @default(now())
    updatedAt           DateTime @default(now()) @updatedAt
    history             OrderHistory[]
    invoiced            Boolean @default(false)
    paid                Boolean @default(false)
    invoiceId           String?
    billingNotes        String?
}

model OrderHistory {
    id         Int      @id @default(autoincrement())
    orderId    Int
    order      Order    @relation(fields: [orderId], references: [id])
    customerId Int
    status     OrderStatus
    changedById Int?     // nullable if system-generated
    changedBy   User? @relation("OrderHistoryChangedBy", fields: [changedById], references: [id])
    updatedAt  DateTime @default(now())
}